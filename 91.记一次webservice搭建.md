# python 实现一个webservice的小功能
刚回学校就被学弟拉进了一个群，群里有人发了个服务器说是免费给我们用，里面有位师傅说要搭个裤子，吼，这个必须水一波啊。(可能有点闲的233)
一开始拿到服务器，先看配置
![](https://github.com/0linlin0/Records/blob/master/images/10.1.jpeg?raw=true)


话说我还没用过这么大配置的机子，不过后来有位大佬说我没见识...物理机的话，这样算一般配置，好吧，怪我咯233

哪位师傅说是一步步带我们搭起来，先让起个mongodb服务，but网上搭裤子的话又很多现有的教程，不过最后还是乖乖的把mongodb搭起来了 [参考连接](https://blog.csdn.net/wqc19920906/article/details/80998777)

大概了解了下这个数据库，和mysql感觉又很大的区别，尤其是用户权限管理，遇到了小小的坑，放上个连接[参考链接]
(https://www.jianshu.com/p/a4e94bb8a052)

数据库建立起来了，建库建表插入数据

然后用pymongo 尝试写了一个小的demo 测试一下是否可以连接

```python
#coding: utf-8
from pymongo import MongoClient
import sys
import getopt

#数据库表结构
#数据库名 test1 表名 default
#字段名称 id name  password

client = MongoClient('*.*.*.*', 7878)
db=client.test1
db.authenticate("test1", "********")
collection = db.default
 
def usage():
	print """
This is usage.
This is usage.
This is usage.
"""
 
def run(argv):
	try:
		opts, args = getopt.getopt(sys.argv[1:], 'n:i:h')
	except getopt.GetoptError:
		usage()
		sys.exit()	
	for opt, arg in opts:
		if opt in ['-h']:
			usage()
		elif opt == '-i':
			result = collection.find_one({'id':arg})
			print(result)
		elif opt == '-n':
			result = collection.find_one({'name': arg})
			print(result)
		else:
			print "Error: invalid parameters"
			usage()
			sys.exit()
 
if __name__ == '__main__':
	run(sys.argv)
```
这里遇到了问题，远程死活连不上数据库，将脚本放到本机上，运行没问题，但是数据库已经设置监听0.0.0.0了，最后发现是服务器防火墙没有开。
这些都设置好以后，就要将代码封装到wsdl中了，之前师傅已经给了一个示例代码
```python
服务端
#!/usr/bin/python
import os
import json
from os import curdir,sep
import sys
import subprocess
from spyne import Application, rpc, ServiceBase
from spyne import Integer, Unicode, Array, ComplexModel
from spyne.protocol.soap import Soap11
from spyne.server.wsgi import WsgiApplication
from wsgiref.simple_server import make_server
from spyne.model.primitive import String
# from mysql import DBmysql
# mysql=DBmysql()
command = "python"
exename = "mysql.py"
sep="\\"
path=os.getcwd()
class SomeSampleServices(ServiceBase):
    @rpc(String, String, _returns = Unicode)
    def greet(self, tname, arr):
       #  shell = []
       #  shell.append(command)
       #  shell.append(path + sep + exename)
       #  keyarr = []
       #  valuearr=[]
       #  params=arr.split(",")
       #  for param in params:
       #      ziduan=param.split("=")
       #      keyarr.append(ziduan[0])
       #      valuearr.append( ziduan[1] )
       #  keystr = ','.join(keyarr)
       #  valuestr = ','.join(valuearr)
       # # print(keystr)
       #  sql = "insert into %s(%s) VALUES (%s)" % (tname, keystr, valuestr)
       #  # shell.append(sql)
       #  # print(shell)
       #  # data = subprocess.check_output(shell, shell=True)
       #  print(sql)
       #  mysql.insertdb(sql)
        return ("ok")
      #  return("aaa")
if __name__ == "__main__":
    soap_app = Application([SomeSampleServices],
                           'SampleServices',
                           in_protocol = Soap11(validator="lxml"),
                           out_protocol = Soap11()
                           )
    wsgi_app = WsgiApplication(soap_app)
    server = make_server('192.168.12.149', 8080, wsgi_app)
    sys.exit(server.serve_forever())
```
```python
客户端
import configparser
import json
from suds.client import Client
class postdata:
    def __init__(self):
        pass
    def getconfig(self, filename, parameter):
        config = configparser.ConfigParser()
        config.read(filename)
        result = config.get("global", parameter)
        return result
    def connwsdl(self,tname,par):
        hosts = self.getconfig('config.ini', 'ip')
        # print(hosts)
        dichost = json.loads(hosts)
        errorlist=[]
        for host in dichost.values():
            # print(host)
            url = "http://%s:%s/?wsdl" % (host,8000)
            # print(url)
            try:
                # url="http://*.*.*.*:8000/?wsdl"
                client = Client(url)
                ret = client.service.greet(tname,par)
            except :
                print("连接出错:%s" % host)
                errorlist.append(host)
        print(errorlist)
        return "ok"

if __name__ == "__main__":
    client = Client("http://192.168.12.149:8080/?wsdl")
    ret = client.service.greet("sss", "ssss")
    # db.connwsdl()
```
我照猫画虎修改以后的，这里吐槽一下啊，python实现webservice网上相关的资料好少啊，搜到一个soaplib库，但是很多都是helloworld的示例，找到一份英文的文档，无奈我渣渣233，所以只能硬着头按照原来代码修改了233

```python
服务端
#!/usr/bin/python
import os
import json
from os import curdir,sep
import sys
import subprocess
from spyne import Application, rpc, ServiceBase
from spyne import Integer, Unicode, Array, ComplexModel
from spyne.protocol.soap import Soap11
from spyne.server.wsgi import WsgiApplication
from wsgiref.simple_server import make_server
from spyne.model.primitive import String
from pymongo import MongoClient

client = MongoClient('*.*.*.*', 7878)
db=client.test1
db.authenticate("test1", "********")
collection = db.default

class sgServices(ServiceBase):
    @rpc(String, String, _returns = Unicode)
    def search(self,option,arg):
      if option=="name":
        result = collection.find_one({'name':arg})
      if option=="id":
        result = collection.find_one({'id':arg})
      return str(result)
if __name__ == "__main__":
    soap_app = Application([sgServices],'sqServices',in_protocol = Soap11(validator="lxml"),out_protocol = Soap11())
    wsgi_app = WsgiApplication(soap_app)
    server = make_server('127.0.0.1', 8080, wsgi_app)
    sys.exit(server.serve_forever())
```
```python
客户端
import configparser
import json
from suds.client import Client

if __name__ == "__main__":
    client = Client("http://127.0.0.1:8080/?wsdl")
    ret = client.service.search("id", "1")
    print ret
```
最后运行着还挺好，最后问师傅，为什么不直接python连接进数据库，还要弄个这个

![](https://github.com/0linlin0/Records/blob/master/images/10.2.png?raw=true)

总之，了解了下python webservice实现，最后放上运行结果

![](https://github.com/0linlin0/Records/blob/master/images/10.3.jpg?raw=true)

接下来按照他的意思，就是php和wsdl对接上就好啦～～

PS:本故事纯属虚构如有雷同，纯属巧合
